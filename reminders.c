#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>


struct event{
	char *event_string ;
	int size ;
  	int priority ;
};

struct event eventlist[100] = {0}; 

int cnt ;


void menu(){
	puts("----------------------------");
	puts("Reminders Menu");
	puts("----------------------------");
	puts("1.show the events in the reminders");
	puts("2.add a new event");
	puts("3.change an event in the reminders");
	puts("4.remove an event in the reminders");
	puts("5.exit");
	puts("----------------------------");
	printf("Your choice:");
}


void show_events(){
	int i ;
	if(!cnt){
		puts("No event in the reminders");		
	}else{
		for(i = 0 ; i < 100; i++){
			if(eventlist[i].event_string){
				printf("%d : %s : %d",i, eventlist[i].event_string, eventlist[i].priority);
			}
		}
		puts("");
	}
}

int add_event(){

	char sizebuf[8] ;
 	char prioritybuf[8] ;
	int length ;
	int prio ;
	int i ;
	int size ;
	if(cnt < 100){
		printf("Please enter the length of event string:");
		read(0,sizebuf,8);
		length = atoi(sizebuf);
		if(length == 0){
			puts("invaild length");
			return 0;
		}
		printf("Please enter the priority of event :");
		read(0,prioritybuf,8);
        prio = atoi(prioritybuf);

		for(i = 0 ; i < 100 ; i++){
			if(!eventlist[i].event_string){
				eventlist[i].size = length ;
        		eventlist[i].priority = prio ;
				eventlist[i].event_string = (char*)malloc(length);
                printf("Please enter the event string:");
				size = read(0,eventlist[i].event_string,length);
				eventlist[i].event_string[size] = '\x00';
				cnt++;
				break;
			}
		}
	}else{
		puts("the reminders is full");
	}
	return 0;
}



void change_event(){
	char indexbuf[8] ;
	char lengthbuf[8] ;
 	char prioritybuf[8] ;
	int length ;
	int index ;
  	int prio ;
	int readsize ;

	if(!cnt){
		puts("No event in the reminders");
	}else{
		printf("Please enter the index of event:");
		read(0,indexbuf,8);
		index = atoi(indexbuf);
		if(eventlist[index].event_string){
			printf("Please enter the length of new event string:");
			read(0,lengthbuf,8);
			length = atoi(lengthbuf);
			printf("Please enter the priority of new event:");
			read(0,prioritybuf,8);
      		prio = atoi(prioritybuf);
      		eventlist[index].priority = prio;
			printf("Please enter the new event string:");
			readsize = read(0,eventlist[index].event_string,length);
			printf("event_size: %d\n", readsize);
            *(eventlist[index].event_string + readsize) = '\x00';
		}else{
			puts("invaild index");
		}		
	}	
}

void remove_event(){
	char indexes[8] ;
	int index ;

	if(!cnt){
		puts("No event in the reminders");
	}else{
		printf("Please enter the index of event:");
		read(0,indexes,8);
		index = atoi(indexes);
		if(eventlist[index].event_string){
			free(eventlist[index].event_string);
			eventlist[index].event_string = 0 ;
			eventlist[index].size = 0 ;
      		eventlist[index].priority = 0 ;
			puts("remove successful!!");
			cnt-- ;			
		}else{
			puts("invaild index");
		}
	}
}

int main(){
	
	char choicebuf[8];
	int choice;
	setvbuf(stdout,0,2,0);
	setvbuf(stdin,0,2,0);

	while(1){
		menu();
		read(0,choicebuf,8);
		choice = atoi(choicebuf);
		switch(choice){
			case 1:
				show_events();
				break;
			case 2:
				add_event();
				break;
			case 3:
				change_event();
				break;
			case 4:
				remove_event();
				break;
			case 5:
				exit(0);
				break;
			default:
        printf("%d", choice);
				puts("invaild choice.");
				break;
		}	
	}
	return 0 ;
}
